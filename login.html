<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ูุฑูุฏ ุจู ุณุณุชู ูุฏุฑุช ููุชูุฑ ุณฺฉู ูุง</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="./global.css">
</head>
<body class="h-screen flex items-center justify-center px-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #667eea 50%, #764ba2 75%, #667eea 100%);">
  <div class="card p-6 max-w-xs w-full shadow-lg rounded-xl mx-auto">
    <div class="text-center mb-5">
      <div class="motorcycle-icon mx-auto mb-3" style="background: linear-gradient(145deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.2) 100%); font-size: 2rem; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin: 0 auto;">
        ๐
      </div>
      <h1 class="text-2xl font-bold text-white">ูุฑูุฏ ุจู ุฏุงุดุจูุฑุฏ</h1>
      <p class="text-gray-300 mt-1 text-sm">ูุทูุงู ูุงู ฺฉุงุฑุจุฑ ู ุฑูุฒ ุนุจูุฑ ุฎูุฏ ุฑุง ูุงุฑุฏ ฺฉูุฏ</p>
    </div>
    <form id="login-form" onsubmit="handleLogin(event)">
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-semibold text-white mb-1.5">ูุงู ฺฉุงุฑุจุฑ</label>
          <input type="text" id="username" class="input-field text-gray-600" placeholder="ูุงู ฺฉุงุฑุจุฑ" required>
        </div>
        <div>
          <label class="block text-sm font-semibold text-white mb-1.5">ุฑูุฒ ุนุจูุฑ</label>
          <input type="password" id="password" class="input-field text-gray-600" placeholder="ุฑูุฒ ุนุจูุฑ" required>
        </div>
        <button type="submit" class="btn btn-success w-full">โ ูุฑูุฏ</button>
      </div>
    </form>
    <div id="login-error" class="mt-3 p-2 bg-red-100 border border-red-400 text-red-700 rounded text-xs hidden">ูุงู ฺฉุงุฑุจุฑ ุง ุฑูุฒ ุนุจูุฑ ุงุดุชุจุงู ุงุณุช</div>
  </div>
    <footer class="absolute bottom-2 left-6 right-6 text-center flex justify-between items-center text-white text-sm border-t border-gray-300">
    <div class="mt-2">
      Developed by <a href="https://github.com/raha652" target="_blank">En.ShAhAb HaMiDi</a> & <a href="https://github.com/emadrasooli" target="_blank">Emad Rasooli</a>
    </div>
    <div>
    </div>
  </footer>
  <script src="googleSheets.js"></script>
  <script>
    let allUsers = []; 
    const usersStorageKey = 'userAccountsData'; 
    function generateId() {
      return Date.now().toString() + Math.random().toString(36).substr(2, 9);
    }

    async function loadUsers() {
      try {
          const stored = localStorage.getItem(usersStorageKey);
allUsers = stored && stored !== 'undefined' ? JSON.parse(stored) : [];
        if (allUsers.length === 0) {
          const defaultAdmin = {
            __backendId: generateId(),
            fullName: 'ุดูุงุจ ุญูุฏ',
            username: 'admin',
            password: 'admin123',
            role: 'admin'
          };
          allUsers.push(defaultAdmin);
          await saveUsers();
        }
        const syncSuccess = await syncUsersWithGoogleSheets();
        if (!syncSuccess) {
          console.warn('ูุดุฏุงุฑ: ููฺฏุงูโุณุงุฒ ุงฺฉุงูุชโูุง ุจุง Google Sheets ูุงูููู ุจูุฏ');
        }
        return allUsers;
      } catch (error) {
        console.error('Error loading users from localStorage:', error);
        return [];
      }
    }

    async function saveUsers(users) {
      try {
        localStorage.setItem(usersStorageKey, JSON.stringify(users));
      } catch (error) {
        console.error('Error saving users from localStorage:', error);
      }
    }
    function mapUserToGS(item) {
      return {
        'Unique ID': item.__backendId,
        'ูุงู ฺฉุงูู': item.fullName,
        'ูุงู ฺฉุงุฑุจุฑ': item.username,
        'ุฑูุฒ ุนุจูุฑ': item.password,
        'ููุด': item.role
      };
    }

    function mapGSToUser(record) {
      return {
        __backendId: record['Unique ID'],
        fullName: record['ูุงู ฺฉุงูู'],
        username: record['ูุงู ฺฉุงุฑุจุฑ'],
        password: record['ุฑูุฒ ุนุจูุฑ'],
        role: record['ููุด']
      };
    }

    async function syncUsersWithGoogleSheets() {
      try {
        const result = await callGoogleSheets('readAll', 'accounts');
        if (result.success) {
          const gsUsers = result.data
            .map(mapGSToUser)
            .filter(user => user.__backendId); 
          const defaultAdminExists = gsUsers.some(u => u.username === 'admin');
          if (!defaultAdminExists) {
            const defaultAdmin = {
              __backendId: generateId(),
              fullName: 'ุดูุงุจ ุญูุฏ',
              username: 'admin',
              password: 'admin123',
              role: 'admin'
            };
            gsUsers.push(defaultAdmin);
          }
          allUsers = gsUsers;
          await saveUsers(allUsers); 
          return true;
        }
        return false;
      } catch (error) {
        console.error('Error syncing users:', error);
        return false;
      }
    }

    function showToast(message, icon = 'โ') {
      console.log(`${icon} ${message}`); 
    }

    async function handleLogin(event) {
      event.preventDefault();
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;

      if (!username || !password) {
        showToast('ูุทูุงู ูุฒุฑูู ู ุฑูุฒ ุนุจูุฑ ุฑุง ูุงุฑุฏ ฺฉูุฏ', 'โ๏ธ');
        return;
      }

      await loadUsers();

      const user = allUsers.find(u => u.username === username && u.password === password);
      if (user) {
        localStorage.setItem('session', JSON.stringify({
          loggedIn: true, 
          fullName: user.fullName, 
          username: user.username, 
          role: user.role
        }));
        showToast('ูุงฺฏู ูููู! ุฏุฑ ุญุงู ุงูุชูุงู...', 'โ');
        window.location.href = 'index.html';
      } else {
        document.getElementById('login-error').classList.remove('hidden');
        document.getElementById('password').value = '';
        document.getElementById('password').focus();
        showToast('ูุฒุฑูู ุง ุฑูุฒ ุนุจูุฑ ุงุดุชุจุงู ุงุณุช', 'โ');
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadUsers();
      document.getElementById('username').focus();
    });
  </script>
</body>

</html>

